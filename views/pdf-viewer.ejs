<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title><%= note.title %> - PDF Viewer</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Work+Sans:wght@400;500;600&display=swap" rel="stylesheet">

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            playfair: ['Playfair Display', 'serif'],
            work: ['Work Sans', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <style>
    body {
      font-family: 'Work Sans', system-ui, sans-serif;
      margin: 0;
      overflow: hidden;
    }

    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    /* Dark mode rendering */
    .dark-mode canvas {
      filter: invert(1) hue-rotate(180deg);
      background: #111;
    }

    /* Loading spinner animation */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .spinner {
      animation: spin 1s linear infinite;
    }

    /* Fade out animation */
    @keyframes fadeOut {
      to { opacity: 0; }
    }

    .fade-out {
      animation: fadeOut 0.3s ease-out forwards;
    }
  </style>
</head>

<body class="m-0">
<div class="flex flex-col h-screen">

  <!-- HEADER -->
  <div class="gradient-bg text-white px-4 sm:px-8 py-4 shadow-lg z-10">
    <div class="max-w-7xl mx-auto flex justify-between items-center gap-4">

      <div class="min-w-0">
        <div class="text-xs opacity-85 mb-1 overflow-x-auto whitespace-nowrap">
          <a href="/" class="opacity-80 hover:underline">Home</a> /
          <a href="/degrees/<%= degree._id %>" class="opacity-80 hover:underline"><%= degree.name %></a> /
          <a href="/semesters/<%= semester._id %>" class="opacity-80 hover:underline">Sem <%= semester.number %></a> /
          <a href="/subjects/<%= subject._id %>" class="opacity-80 hover:underline"><%= subject.name %></a>
        </div>

        <h1 class="font-playfair text-xl sm:text-2xl font-bold truncate">
          <%= note.title %>
        </h1>

        <div class="text-xs sm:text-sm opacity-90 mt-1">
          ğŸ“ <%= note.author %> Â·
          ğŸ“… <%= new Date(note.uploadDate).toLocaleDateString() %>
        </div>
      </div>

      <!-- Dark Mode Button -->
      <button
        id="darkToggle"
        class="bg-white/20 hover:bg-white/30 px-3 py-2 rounded-lg text-sm backdrop-blur transition"
      >
        ğŸŒ™ Dark
      </button>

    </div>
  </div>

  <!-- LOADING INDICATOR -->
  <div id="loading-indicator" class="flex-1 flex flex-col items-center justify-center bg-gray-700">
    <div class="text-center">
      <!-- Spinner -->
      <div class="spinner w-16 h-16 border-4 border-white/30 border-t-white rounded-full mb-4 mx-auto"></div>
      
      <!-- Loading text -->
      <div class="text-white text-lg font-medium mb-2">Loading PDF...</div>
      <div class="text-white/70 text-sm">Please wait</div>
    </div>
  </div>

  <!-- PDF VIEW -->
  <div id="pdf-container" class="flex-1 overflow-auto bg-gray-700 px-2 sm:px-6 py-4 hidden">
    <div id="pdf-viewer" class="max-w-5xl mx-auto space-y-6"></div>
  </div>

</div>

<script>
  const pdfUrl = "<%= note.pdfUrl %>";
  const viewer = document.getElementById("pdf-viewer");
  const container = document.getElementById("pdf-container");
  const darkToggle = document.getElementById("darkToggle");
  const loadingIndicator = document.getElementById("loading-indicator");

  let isDark = false;

  pdfjsLib.GlobalWorkerOptions.workerSrc =
    "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";

  // Dark mode toggle
  darkToggle.onclick = () => {
    isDark = !isDark;
    container.classList.toggle("dark-mode", isDark);
    darkToggle.textContent = isDark ? "â˜€ï¸ Light" : "ğŸŒ™ Dark";
  };

  // Hide loading indicator and show PDF container
  function hideLoading() {
    loadingIndicator.classList.add("fade-out");
    setTimeout(() => {
      loadingIndicator.classList.add("hidden");
      container.classList.remove("hidden");
    }, 300);
  }

  pdfjsLib.getDocument(pdfUrl).promise.then(pdf => {
    // Hide loading indicator once PDF is loaded
    hideLoading();

    const isMobile = window.innerWidth < 768;
    const scale = isMobile ? 1.1 : 1.5;

    const observer = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if (entry.isIntersecting && !entry.target.dataset.rendered) {
          renderPage(+entry.target.dataset.page, scale, entry.target);
          entry.target.dataset.rendered = "true";
          observer.unobserve(entry.target);
        }
      });
    }, {
      root: container,
      rootMargin: "300px"
    });

    for (let i = 1; i <= pdf.numPages; i++) {
      const placeholder = document.createElement("div");
      placeholder.dataset.page = i;
      placeholder.className = "flex justify-center";
      placeholder.style.minHeight = "100vh";
      viewer.appendChild(placeholder);
      observer.observe(placeholder);
    }

    function renderPage(pageNum, scale, wrapper) {
      pdf.getPage(pageNum).then(page => {
        const viewport = page.getViewport({ scale });
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");

        canvas.width = viewport.width;
        canvas.height = viewport.height;
        canvas.className =
          "rounded-lg shadow-xl bg-white mb-4";

        wrapper.appendChild(canvas);

        page.render({ canvasContext: ctx, viewport });
      });
    }
  }).catch(err => {
    // Hide loading and show error
    loadingIndicator.classList.add("hidden");
    container.classList.remove("hidden");
    viewer.innerHTML = `<div class="text-white text-center py-10">âŒ Failed to load PDF</div>`;
    console.error(err);
  });
</script>

</body>
</html>